name: Pipeline Core Validation

# Reusable workflow for Terraform validation across all projects
# Includes: TFLint, tfsec, Checkov, Terraform fmt/validate, Terraform Docs
# Ready for future additions: tf-cost, driftctl, sentinel, etc.

on:
  workflow_call:
    inputs:
      terraform_dir:
        description: 'Terraform working directory'
        required: false
        type: string
        default: 'terraform'
      terraform_version:
        description: 'Terraform version (e.g., 1.9.0, ~1.9.0)'
        required: false
        type: string
        default: '~1.9.0'
      generate_tfdocs:
        description: 'Generate Terraform documentation'
        required: false
        type: boolean
        default: true
      enable_tfsec:
        description: 'Enable tfsec scanning'
        required: false
        type: boolean
        default: true
      enable_checkov:
        description: 'Enable Checkov scanning'
        required: false
        type: boolean
        default: true
      enable_tflint:
        description: 'Enable TFLint linting'
        required: false
        type: boolean
        default: true
      enable_tf_cost:
        description: 'Enable Terraform Cost Estimation (future)'
        required: false
        type: boolean
        default: false
      soft_fail:
        description: 'Continue on validation errors (soft fail)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  terraform-format:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.terraform_dir }}/.terraform
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles(format('{0}/.terraform.lock.hcl', inputs.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Terraform Format
        id: fmt
        working-directory: ${{ inputs.terraform_dir }}
        run: terraform fmt -recursive
        continue-on-error: ${{ inputs.soft_fail }}

      - name: Terraform Format Summary
        if: always()
        run: |
          if [ "${{ steps.fmt.outcome }}" == "failure" ]; then
            echo "‚ö†Ô∏è Terraform format had issues"
          else
            echo "‚úÖ Terraform formatted"
          fi

  tflint-scan:
    name: TFLint Linting
    needs: terraform-format
    runs-on: ubuntu-latest
    if: inputs.enable_tflint == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles(format('{0}/.tflint.hcl', inputs.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-tflint-

      - name: TFLint Init and Scan
        id: tflint
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          tflint --init
          tflint -f compact
        continue-on-error: ${{ inputs.soft_fail }}

      - name: TFLint Summary
        if: always()
        run: |
          if [ "${{ steps.tflint.outcome }}" == "failure" ]; then
            echo "‚ö†Ô∏è TFLint found issues"
          else
            echo "‚úÖ TFLint scan passed"
          fi

  tfsec-scan:
    name: tfsec Security Scan
    needs: [terraform-format, tflint-scan]
    runs-on: ubuntu-latest
    if: inputs.enable_tfsec == true && always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: tfsec Scan
        id: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ inputs.terraform_dir }}
          soft_fail: ${{ inputs.soft_fail }}
          format: sarif

      - name: Upload tfsec SARIF Report
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('results.sarif') != ''
        with:
          sarif_file: results.sarif
          category: tfsec

      - name: tfsec Summary
        if: always()
        run: |
          if [ "${{ steps.tfsec.outcome }}" == "failure" ]; then
            echo "üîí tfsec found security issues"
          else
            echo "‚úÖ tfsec scan passed"
          fi

  checkov-scan:
    name: Checkov Policy Scan
    needs: [terraform-format, tflint-scan, tfsec-scan]
    runs-on: ubuntu-latest
    if: inputs.enable_checkov == true && always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Checkov
        run: pip install checkov

      - name: Checkov Scan
        id: checkov
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          checkov -d . --output sarif --output-file-path ../results.sarif --output cli 2>&1 | tee checkov-output.txt
          CHECKOV_EXIT=$?
          echo "checkov_exit=$CHECKOV_EXIT" >> $GITHUB_OUTPUT
          if [ "${{ inputs.soft_fail }}" == "true" ]; then
            exit 0
          else
            exit $CHECKOV_EXIT
          fi
        continue-on-error: ${{ inputs.soft_fail }}

      - name: Upload Checkov SARIF Report
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif/results_sarif.sarif
          category: checkov

      - name: Checkov Summary
        if: always()
        run: |
          if [ "${{ steps.checkov.outcome }}" == "failure" ]; then
            echo "üìã Checkov found policy violations"
          else
            echo "‚úÖ Checkov scan passed"
          fi

  tf-cost-estimation:
    runs-on: ubuntu-latest
    if: inputs.enable_tf_cost == true
    needs: [terraform-format, tflint-scan, tfsec-scan, checkov-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Init (for cost estimation)
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          terraform init -input=false -backend=false

      - name: Placeholder - tf-cost
        run: |
          echo "‚ÑπÔ∏è tf-cost integration coming soon"
          echo "Tools to consider: infracost, cloud.tf, terraform-cost-cli"

  terraform-docs:
    name: Generate Terraform Documentation
    needs: [terraform-format, tflint-scan, tfsec-scan, checkov-scan, tf-cost-estimation]
    runs-on: ubuntu-latest
    if: inputs.generate_tfdocs == true && always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Render Terraform Docs
        uses: terraform-docs/gh-actions@v1.3.0
        with:
          working-dir: ${{ inputs.terraform_dir }}
          output-file: README.md
          output-method: inject
          git-push: false

      - name: Check Documentation Changes
        id: docs_check
        run: |
          if git diff --quiet; then
            echo "docs_changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Documentation is up to date"
          else
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Documentation changes detected"
            git diff --name-only
          fi

      - name: Comment PR with Documentation Status
        if: github.event_name == 'pull_request' && steps.docs_check.outputs.docs_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è Terraform documentation is out of date. Please run:\n```bash\nterraform-docs -c . ${{ inputs.terraform_dir }}\n```'
            })

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-format, tflint-scan, tfsec-scan, checkov-scan, tf-cost-estimation, terraform-docs]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## üìä Pipeline Core Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.terraform-format.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint-scan.result == 'success' && '‚úÖ' || needs.tflint-scan.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec | ${{ needs.tfsec-scan.result == 'success' && '‚úÖ' || needs.tfsec-scan.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ needs.checkov-scan.result == 'success' && '‚úÖ' || needs.checkov-scan.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.terraform-docs.result == 'success' && '‚úÖ' || needs.terraform-docs.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Directory**: \`${{ inputs.terraform_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: \`${{ inputs.terraform_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Soft Fail**: \`${{ inputs.soft_fail }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        if: |
          needs.terraform-format.result == 'failure' ||
          needs.tflint-scan.result == 'failure' ||
          needs.tfsec-scan.result == 'failure' ||
          needs.checkov-scan.result == 'failure' ||
          needs.terraform-docs.result == 'failure'
        run: |
          echo "‚ùå One or more validation checks failed!"
          echo "Format: ${{ needs.terraform-format.result }}"
          echo "TFLint: ${{ needs.tflint-scan.result }}"
          echo "tfsec: ${{ needs.tfsec-scan.result }}"
          echo "Checkov: ${{ needs.checkov-scan.result }}"
          echo "Docs: ${{ needs.terraform-docs.result }}"
          exit 1

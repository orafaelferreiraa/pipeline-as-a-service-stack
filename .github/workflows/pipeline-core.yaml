name: Pipeline Core Validation

# Reusable workflow for Terraform validation across all projects
# Includes: TFLint, tfsec, Checkov, Terraform fmt/validate, Terraform Docs
# Ready for future additions: tf-cost, driftctl, sentinel, etc.

on:
  workflow_call:
    inputs:
      terraform_dir:
        description: 'Terraform working directory'
        required: false
        type: string
        default: 'terraform'
      terraform_version:
        description: 'Terraform version (e.g., 1.9.0, ~1.9.0)'
        required: false
        type: string
        default: '~1.9.0'
      generate_tfdocs:
        description: 'Generate Terraform documentation'
        required: false
        type: boolean
        default: true
      enable_tfsec:
        description: 'Enable tfsec scanning'
        required: false
        type: boolean
        default: true
      enable_checkov:
        description: 'Enable Checkov scanning'
        required: false
        type: boolean
        default: true
      enable_tflint:
        description: 'Enable TFLint linting'
        required: false
        type: boolean
        default: true
      # enable_tf_cost:
      #   description: 'Enable Terraform Cost Estimation (future)'
      #   required: false
      #   type: boolean
      #   default: false
      soft_fail:
        description: 'Continue on validation errors (soft fail)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  terraform-format:
    name: Terraform Format
    runs-on: ubuntu-latest
    outputs:
      outcome: ${{ steps.fmt.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Format
        id: fmt
        working-directory: ${{ inputs.terraform_dir }}
        run: terraform fmt -recursive
        continue-on-error: true

  tflint-scan:
    name: TFLint Linting
    needs: terraform-format
    runs-on: ubuntu-latest
    if: inputs.enable_tflint == true
    outputs:
      outcome: ${{ steps.tflint.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles(format('{0}/.tflint.hcl', inputs.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-tflint-

      - name: TFLint Init and Scan
        id: tflint
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          tflint --init
          tflint -f compact
        continue-on-error: true

  tfsec-scan:
    name: tfsec Security Scan
    needs: [terraform-format, tflint-scan]
    runs-on: ubuntu-latest
    if: inputs.enable_tfsec == true && always()
    outputs:
      outcome: ${{ steps.tfsec.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: tfsec Scan
        id: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ inputs.terraform_dir }}
          format: sarif
        continue-on-error: true

      - name: Upload tfsec SARIF Report
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('results.sarif') != ''
        with:
          sarif_file: results.sarif
          category: tfsec

  checkov-scan:
    name: Checkov Policy Scan
    needs: [terraform-format, tflint-scan, tfsec-scan]
    runs-on: ubuntu-latest
    if: inputs.enable_checkov == true && always()
    outputs:
      outcome: ${{ steps.checkov.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Checkov
        run: pip install checkov

      - name: Checkov Scan
        id: checkov
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          set -o pipefail
          checkov -d . --output sarif --output-file-path ../results.sarif --output cli 2>&1 | tee checkov-output.txt
        continue-on-error: true

      - name: Upload Checkov SARIF Report
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif/results_sarif.sarif
          category: checkov

  # tf-cost-estimation:
  #   runs-on: ubuntu-latest
  #   if: inputs.enable_tf_cost == true
  #   needs: [terraform-format, tflint-scan, tfsec-scan, checkov-scan]
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_version: ${{ inputs.terraform_version }}
  #
  #     - name: Terraform Init (for cost estimation)
  #       working-directory: ${{ inputs.terraform_dir }}
  #       run: |
  #         terraform init -input=false -backend=false
  #
  #     - name: Placeholder - tf-cost
  #       run: |
  #         echo "‚ÑπÔ∏è tf-cost integration coming soon"
  #         echo "Tools to consider: infracost, cloud.tf, terraform-cost-cli"

  terraform-docs:
    name: Generate Terraform Documentation
    needs: [terraform-format, tflint-scan, tfsec-scan, checkov-scan]
    runs-on: ubuntu-latest
    if: inputs.generate_tfdocs == true && always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Render Terraform Docs
        uses: terraform-docs/gh-actions@v1.3.0
        with:
          working-dir: ${{ inputs.terraform_dir }}
          output-file: README.md
          output-method: inject
          git-push: false

      - name: Check Documentation Changes
        id: docs_check
        run: |
          if git diff --quiet; then
            echo "docs_changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Documentation is up to date"
          else
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Documentation changes detected"
            git diff --name-only
          fi

      - name: Comment PR with Documentation Status
        if: github.event_name == 'pull_request' && steps.docs_check.outputs.docs_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è Terraform documentation is out of date. Please run:\n```bash\nterraform-docs -c . ${{ inputs.terraform_dir }}\n```'
            })

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-format, tflint-scan, tfsec-scan, checkov-scan, terraform-docs]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## üìä Pipeline Core Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.terraform-format.outputs.outcome == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint-scan.outputs.outcome == 'success' && '‚úÖ' || needs.tflint-scan.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec | ${{ needs.tfsec-scan.outputs.outcome == 'success' && '‚úÖ' || needs.tfsec-scan.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ needs.checkov-scan.outputs.outcome == 'success' && '‚úÖ' || needs.checkov-scan.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.terraform-docs.result == 'success' && '‚úÖ' || needs.terraform-docs.result == 'skipped' && '‚äò' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Directory**: \`${{ inputs.terraform_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: \`${{ inputs.terraform_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Soft Fail**: \`${{ inputs.soft_fail }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        run: |
          FAILED=false

          echo "### Scan Outcomes"
          echo "Format: ${{ needs.terraform-format.outputs.outcome || 'skipped' }}"
          echo "TFLint: ${{ needs.tflint-scan.outputs.outcome || 'skipped' }}"
          echo "tfsec: ${{ needs.tfsec-scan.outputs.outcome || 'skipped' }}"
          echo "Checkov: ${{ needs.checkov-scan.outputs.outcome || 'skipped' }}"
          echo "Docs: ${{ needs.terraform-docs.result }}"
          echo ""

          if [ "${{ needs.terraform-format.outputs.outcome }}" == "failure" ]; then
            echo "‚ùå Terraform Format: FAILED"
            FAILED=true
          fi
          if [ "${{ needs.tflint-scan.outputs.outcome }}" == "failure" ]; then
            echo "‚ùå TFLint: FAILED"
            FAILED=true
          fi
          if [ "${{ needs.tfsec-scan.outputs.outcome }}" == "failure" ]; then
            echo "‚ùå tfsec: FAILED"
            FAILED=true
          fi
          if [ "${{ needs.checkov-scan.outputs.outcome }}" == "failure" ]; then
            echo "‚ùå Checkov: FAILED"
            FAILED=true
          fi
          if [ "${{ needs.terraform-docs.result }}" == "failure" ]; then
            echo "‚ùå Terraform Docs: FAILED"
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo ""
            echo "‚ùå One or more validation checks failed!"
            if [ "${{ inputs.soft_fail }}" == "true" ]; then
              echo "‚ö†Ô∏è soft_fail=true ‚Äî reporting as warning only, pipeline continues"
            else
              exit 1
            fi
          else
            echo "‚úÖ All validation checks passed!"
          fi
